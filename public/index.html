<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Lead Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
</head>

<body class="bg-gray-100 min-h-screen p-6">


    <!-- Navbar -->
    <nav
        class="bg-gradient-to-r from-orange-500 to-purple-600 text-white shadow-md rounded-lg mb-6 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2 text-2xl font-bold">
            <a href="/index.html" ><i class="fas fa-chart-line"></i>
            <span>Dashboard</span></a>
        </div>
        <div class="flex items-center gap-6 text-lg">
            <a href="/leads.html" class="flex items-center gap-1 ">
                <i class="fas fa-database"></i> Leads
            </a>
            <button onclick="openSettingsModal()" class="flex items-center gap-1 ">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </nav>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="bg-white p-4 shadow rounded border-l-4 border-orange-500">
            <h2 class="text-lg font-semibold text-gray-600">Total Leads</h2>
            <p id="totalLeads" class="text-2xl font-bold text-purple-700">...</p>
        </div>
        <div class="bg-white p-4 shadow rounded border-l-4 border-orange-500">
            <h2 class="text-lg font-semibold text-gray-600">Researched</h2>
            <p id="researched" class="text-2xl font-bold text-purple-700">...</p>
        </div>
        <div class="bg-white p-4 shadow rounded border-l-4 border-orange-500">
            <h2 class="text-lg font-semibold text-gray-600">Drafted</h2>
            <p id="drafted" class="text-2xl font-bold text-purple-700">...</p>
        </div>
        <div class="bg-white p-4 shadow rounded border-l-4 border-yellow-500">
            <h2 class="text-lg font-semibold text-gray-600">Not Contacted</h2>
            <p id="notContactedLeads" class="text-2xl font-bold text-purple-700">...</p>
        </div>
        <div class="bg-white p-4 shadow rounded border-l-4 border-green-500">
            <h2 class="text-lg font-semibold text-gray-600">Connected</h2>
            <p id="connectedLeads" class="text-2xl font-bold text-purple-700">...</p>
        </div>
        <div class="bg-white p-4 shadow rounded border-l-4 border-green-500">
            <h2 class="text-lg font-semibold text-gray-600">Message Sent</h2>
            <p id="sent" class="text-2xl font-bold text-purple-700">...</p>
        </div>

    </div>
<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
    <button onclick="closeEditModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500 text-lg">
      <i class="fas fa-times"></i>
    </button>
    <h2 class="text-xl font-bold text-purple-700 mb-4 flex items-center gap-2">
      <i class="fas fa-pen"></i> Edit Lead
    </h2>
    <form id="editForm">
      <input type="hidden" id="editId" />

      <label class="block mb-1 text-sm font-semibold text-gray-700">SrNo</label>
      <input id="editSrNo" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-3">
      <label class="block mb-1 text-sm font-semibold text-gray-700">Name</label>
      <input id="editName" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-3">

      <label class="block mb-1 text-sm font-semibold text-gray-700">Company</label>
      <input id="editCompany" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-3">

      <label class="block mb-1 text-sm font-semibold text-gray-700">City</label>
      <input id="editCity" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-3">
      <label class="block mb-1 text-sm font-semibold text-gray-700">LinkedIn</label>
<input id="editLinkedin" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-3">


      <label class="block mb-1 text-sm font-semibold text-gray-700">Status</label>
      <input id="editStatus" type="text" class="w-full border border-gray-300 rounded px-4 py-2 mb-4">

      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-white bg-orange-400 rounded hover:bg-orange-300">
          <i class="fas fa-times-circle"></i> Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
          <i class="fas fa-save"></i> Update
        </button>
      </div>
    </form>
  </div>
</div>


    <!-- Today's Leads Table -->
    <div class="flex justify-between items-center mb-4">
  <h2 class="text-xl font-bold text-orange-600 flex items-center gap-2">
    <i class="fas fa-calendar-day "></i> Today's Researched Leads
  </h2>
  <div class="flex gap-3">
    <button onclick="assignTodaysLeads()" class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm">
      <i class="fas fa-random mr-1"></i> Assign for Today
    </button>
    <div class="flex gap-4 text-sm text-gray-700 font-semibold items-center">
      <div><i class="fas fa-paper-plane text-grey-600 mr-1"></i> Sent: <span id="countSent" class="text-purple-700">0</span></div>
      <div><i class="fas fa-clock text-red-600 mr-1"></i>  Pending: <span id="countPending" class="text-orange-600">0</span></div>
      <div><i class="fas fa-check-circle text-green-600 mr-1"></i> Connected: <span id="countConnected" class="text-green-600">0</span></div>
    </div>
  </div>
</div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-400 text-sm">
                <thead class="bg-purple-500 text-white">
                    <tr>
                        <th class="px-4 py-2 font-semibold text-left">SrNo.</th>
                        <th class="px-4 py-2 font-semibold text-left">Name</th>
                        <th class="px-4 py-2 font-semibold text-left">Company</th>
                        <th class="px-4 py-2 font-semibold text-left">City</th>
                        <th class="px-4 py-2 font-semibold text-left">LinkedIn</th>
                        <th class="px-4 py-2 font-semibold text-left">Status</th>
                        <th class="px-4 py-2 font-semibold text-center">Req Accepted</th>
                        <th class="px-4 py-2 font-semibold text-center">Req Sent</th>
                        <th class="px-4 py-2 font-semibold text-center">Msg Sent</th>
                        <th class="px-4 py-2 font-semibold text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="todaysLeadsTable" class="divide-y divide-gray-200 bg-white">
                    <!-- JS will populate rows here -->
                </tbody>
            </table>
        </div>
        <div id="pagination" class="flex justify-center mt-4 space-x-2"></div>
    </div>

    <!-- Settings Modal -->
    <!-- <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center"> -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">

        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button onclick="closeSettingsModal()"
                class="absolute top-3 right-4 text-gray-400 hover:text-red-500 text-lg">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-bold text-purple-700 mb-4 flex items-center gap-2">
                <i class="fas fa-cog"></i> Settings
            </h2>
            <label for="linkedinToken" class="block mb-1 text-sm font-semibold text-gray-700">
                <i class="fab fa-linkedin me-1"></i> LinkedIn Token
            </label>
            <input id="linkedinToken" type="text" placeholder="Enter your li_at token"
                class="w-full border border-purple-300 rounded px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500">

            <div class="flex justify-end gap-3">
                <button onclick="closeSettingsModal()" class="px-4 py-2 text-white bg-orange-400 rounded hover:bg-orange-300">
                    <i class="fas fa-times-circle"></i> Cancel
                </button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
     document.getElementById('editForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const id = document.getElementById('editId').value;
  const updatedData = {
    SrNo: document.getElementById('editSrNo').value.trim(),
    name: document.getElementById('editName').value.trim(),
    companyname: document.getElementById('editCompany').value.trim(),
    city: document.getElementById('editCity').value.trim(),
    linkedin: document.getElementById('editLinkedin').value.trim(),
    status: document.getElementById('editStatus').value.trim(),
  };

  const res = await fetch(`/api/leads/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updatedData)
  });

  const result = await res.json();
  if (result.modifiedCount > 0 || result.acknowledged) {
    showToast(`<i class="fa-solid fa-check-circle"></i> Lead updated!`);
    closeEditModal();
    loadTodaysLeads(currentPage);
  } else {
    showToast(`<i class="fa-solid fa-times-circle"></i> Update failed`, 'error');
  }
});

function bindEditButtons() {
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      openEditModal({
        _id: btn.dataset.id,
        srno: btn.dataset.srno,
        name: btn.dataset.name,
        companyname: btn.dataset.company,
        city: btn.dataset.city,
        status: btn.dataset.status
      });
    });
  });
}


        let currentPage = 1;

        async function loadSummary() {
            const res = await fetch('/api/dashboard-summary');
            const { total, connected, sent, notContacted, researched, drafted } = await res.json();
            document.getElementById('totalLeads').textContent = total;
            document.getElementById('drafted').textContent = drafted;
            document.getElementById('sent').textContent = sent;
            document.getElementById('researched').textContent = researched;
            document.getElementById('connectedLeads').textContent = connected;
            document.getElementById('notContactedLeads').textContent = notContacted;
        }

       async function loadTodaysLeads(page = 1) {
    currentPage = page; // ✅ this keeps track globally
    const res = await fetch(`/api/todays-leads?page=${page}&limit=10`);
    const { data, total } = await res.json();

    const table = document.getElementById('todaysLeadsTable');
    table.innerHTML = '';

    if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">No leads found</td></tr>`;
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    data.forEach(lead => {
        const row = document.createElement('tr');
        row.className = "hover:bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-2">${lead.SrNo || ''}</td>
          <td class="px-4 py-2">${lead.name || ''}</td>
          <td class="px-4 py-2">${lead.companyname || ''}</td>
          <td class="px-4 py-2">${lead.city || ''}</td>
          <td class="px-4 py-2"><a href="${lead.linkedin || '#'}" target="_blank" class="text-blue-600 hover:underline">View</a></td>
          <td class="px-4 py-2">${lead.status || ''}</td>
          <td class="px-4 py-2 text-center">${lead.req ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
          <td class="px-4 py-2 text-center">${lead.sent ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
          <td class="px-4 py-2 text-center">${lead.msgsent ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
         <td class="px-4 py-2 text-center flex gap-2 justify-center">
    <button class="text-purple-600 hover:text-purple-800 text-sm edit-btn"
      data-id="${lead._id}"
      data-name="${lead.name || ''}"
      data-company="${lead.companyname || ''}"
      data-city="${lead.city || ''}"
      data-status="${lead.status || ''}">
      <i class="fas fa-edit"></i>
    </button>
    <button onclick="deleteLead('${lead._id}')" class="text-red-500 hover:text-red-700 text-sm">
      <i class="fas fa-trash-alt"></i>
    </button>
  </td>

        `;
        table.appendChild(row);
    });
    const max = 50;
    renderPagination(max, 10);
    bindEditButtons()
}

async function deleteLead(id) {
  if (!confirm("Are you sure you want to delete this lead?")) return;
  const res = await fetch(`/api/leads/${id}`, { method: 'DELETE' });
  const result = await res.json();
  if (result.deletedCount > 0) {
    showToast(`<i class="fa-solid fa-trash"></i> Lead deleted`);
    loadTodaysLeads(currentPage);
  } else {
    showToast(`<i class="fa-solid fa-triangle-exclamation"></i> Delete failed`, 'error');
  }
}

      function renderPagination(total, limit) {
  const totalPages = Math.ceil(total / limit);
  const container = document.getElementById('pagination');
  container.innerHTML = '';

  const maxButtonsToShow = 7; // including first, last, current ±1, prev/next

  const createButton = (label, page, isActive = false, isDisabled = false) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.className = `px-3 py-1 rounded border text-sm transition ${
      isDisabled ? 'cursor-not-allowed bg-gray-200 text-gray-400' :
      isActive ? 'bg-purple-600 text-white' :
      'bg-white border-purple-500 text-purple-600 hover:bg-purple-100'
    }`;
    if (!isDisabled) {
      btn.onclick = () => {
        currentPage = page;
        loadTodaysLeads(page);
      };
    }
    container.appendChild(btn);
  };

  // Previous button
  createButton('«', currentPage - 1, false, currentPage === 1);

  // Page buttons with ellipses logic
  const range = [];
  if (totalPages <= 10) {
    for (let i = 1; i <= totalPages; i++) range.push(i);
  } else {
    range.push(1);
    if (currentPage > 4) range.push('...');
    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
      range.push(i);
    }
    if (currentPage < totalPages - 3) range.push('...');
    range.push(totalPages);
  }

  range.forEach(p => {
    if (p === '...') {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'px-2 text-gray-500';
      container.appendChild(dots);
    } else {
      createButton(p, p, p === currentPage);
    }
  });

  // Next button
  createButton('»', currentPage + 1, false, currentPage === totalPages);
}



        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            fetch('/api/settings/linkedin-token')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('linkedinToken').value = data.linkedinToken || '';
                });
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        async function saveSettings() {
            const token = document.getElementById('linkedinToken').value.trim();
            const res = await fetch('/api/settings/linkedin-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ linkedinToken: token })
            });
            const result = await res.json();

            if (result.success) {
                const msg = `<i class="fa-solid fa-circle-check"></i> Token saved!`;
                showToast(msg);
                closeSettingsModal();
            } else {
                showToast(`<i class="fa-solid fa-circle-xmark"></i> Failed to save`, 'error');
            }

        }

        loadTodaysLeads();
        loadSummary();
    </script>
    <script>
        function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `px-4 py-2 rounded shadow text-white text-sm animate-slide-in ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;

    toast.innerHTML = message; // ✅ allow icons and formatting

    const container = document.getElementById('toastContainer');
    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
function openEditModal(lead) {
  document.getElementById('editId').value = lead._id;
  document.getElementById('editSrNo').value = lead.SrNo || '';
  document.getElementById('editName').value = lead.name || '';
  document.getElementById('editCompany').value = lead.companyname || '';
  document.getElementById('editCity').value = lead.city || '';
  document.getElementById('editLinkedin').value = lead.linkedin || '';
  document.getElementById('editStatus').value = lead.status || '';
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const id = document.getElementById('editId').value;
  const updatedData = {
    name: document.getElementById('editName').value.trim(),
    companyname: document.getElementById('editCompany').value.trim(),
    city: document.getElementById('editCity').value.trim(),
    status: document.getElementById('editStatus').value.trim(),
  };

  const res = await fetch(`/api/leads/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updatedData)
  });

  const result = await res.json();
  if (result.modifiedCount > 0 || result.acknowledged) {
    showToast(`<i class="fa-solid fa-check-circle"></i> Lead updated!`);
    closeEditModal();
    loadTodaysLeads(currentPage);
  } else {
    showToast(`<i class="fa-solid fa-times-circle"></i> Update failed`, 'error');
  }
});


// function closeEditModal() {
//     document.getElementById('editModal').classList.add('hidden');
// }

    </script>

    <style>
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
            transition: opacity 0.3s ease-in;
        }
    </style>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>

</body>

</html>
